{"model_name_or_path": "250522_anthropic_filemap_simple_review__claude-sonnet-4-20250514__t-0.00__p-1.00__c-3.00___swe_bench_verified_test", "instance_id": "django__django-15098", "model_patch": "diff --git a/debug_detailed.py b/debug_detailed.py\nnew file mode 100644\nindex 0000000000..3bd36d5a5d\n--- /dev/null\n+++ b/debug_detailed.py\n@@ -0,0 +1,99 @@\n+#!/usr/bin/env python\n+\"\"\"\n+Detailed debugging of the language resolution issue.\n+\"\"\"\n+\n+import django\n+from django.conf import settings\n+from django.test import RequestFactory\n+from django.middleware.locale import LocaleMiddleware\n+from django.utils.translation import get_language, get_language_from_path, get_language_from_request, activate\n+from django.conf.urls.i18n import is_language_prefix_patterns_used\n+\n+# Configure Django settings\n+if not settings.configured:\n+    settings.configure(\n+        DEBUG=True,\n+        SECRET_KEY='test-secret-key',\n+        USE_I18N=True,\n+        LANGUAGE_CODE='en-us',\n+        LANGUAGES=[\n+            ('en-us', \"English\"),\n+            ('en-latn-us', \"Latin English\"),\n+            ('en-Latn-US', \"BCP 47 case format\"),\n+        ],\n+        MIDDLEWARE=[\n+            'django.middleware.locale.LocaleMiddleware',\n+        ],\n+        ALLOWED_HOSTS=['testserver'],\n+    )\n+\n+django.setup()\n+\n+from django.conf.urls.i18n import i18n_patterns\n+from django.http import HttpResponse\n+from django.urls import path\n+\n+def test_view(request):\n+    return HttpResponse('OK')\n+\n+# Create a test URLs module\n+import sys\n+from types import ModuleType\n+urls_module = ModuleType('test_urls')\n+urls_module.urlpatterns = i18n_patterns(path('', test_view))\n+sys.modules['test_urls'] = urls_module\n+settings.ROOT_URLCONF = 'test_urls'\n+\n+def debug_detailed():\n+    \"\"\"Detailed debugging of the language resolution.\"\"\"\n+    print(\"Detailed debugging of language resolution:\")\n+    print(\"=\" * 60)\n+    \n+    factory = RequestFactory()\n+    \n+    path = '/en-Latn-US/'\n+    print(f\"Testing path: {path}\")\n+    \n+    request = factory.get(path)\n+    print(f\"  Request path_info: {request.path_info}\")\n+    \n+    # Step 1: Check get_language_from_path\n+    lang_from_path = get_language_from_path(request.path_info)\n+    print(f\"  get_language_from_path: {lang_from_path}\")\n+    \n+    # Step 2: Check is_language_prefix_patterns_used\n+    urlconf = getattr(request, 'urlconf', settings.ROOT_URLCONF)\n+    i18n_patterns_used, prefixed_default_language = is_language_prefix_patterns_used(urlconf)\n+    print(f\"  i18n_patterns_used: {i18n_patterns_used}\")\n+    print(f\"  prefixed_default_language: {prefixed_default_language}\")\n+    \n+    # Step 3: Check get_language_from_request\n+    language = get_language_from_request(request, check_path=i18n_patterns_used)\n+    print(f\"  get_language_from_request: {language}\")\n+    \n+    # Step 4: Check the middleware logic\n+    language_from_path = get_language_from_path(request.path_info)\n+    print(f\"  language_from_path (again): {language_from_path}\")\n+    \n+    if not language_from_path and i18n_patterns_used and not prefixed_default_language:\n+        language = settings.LANGUAGE_CODE\n+        print(f\"  Using LANGUAGE_CODE: {language}\")\n+    \n+    # Step 5: Activate the language\n+    print(f\"  Language before activation: {get_language()}\")\n+    activate(language)\n+    print(f\"  Language after activation: {get_language()}\")\n+    \n+    # Step 6: Test the middleware directly\n+    print(\"\\n  Testing middleware directly:\")\n+    activate('en-us')  # Reset to default\n+    print(f\"    Language before middleware: {get_language()}\")\n+    \n+    middleware = LocaleMiddleware(lambda req: HttpResponse('OK'))\n+    middleware.process_request(request)\n+    print(f\"    Language after middleware: {get_language()}\")\n+    print(f\"    request.LANGUAGE_CODE: {getattr(request, 'LANGUAGE_CODE', 'Not set')}\")\n+\n+if __name__ == '__main__':\n+    debug_detailed()\n\\ No newline at end of file\ndiff --git a/debug_issue.py b/debug_issue.py\nnew file mode 100644\nindex 0000000000..24bb337c2e\n--- /dev/null\n+++ b/debug_issue.py\n@@ -0,0 +1,86 @@\n+#!/usr/bin/env python\n+\"\"\"\n+Debug script to understand the i18n patterns issue in detail.\n+\"\"\"\n+\n+import os\n+import sys\n+import django\n+from django.conf import settings\n+from django.test import RequestFactory\n+from django.urls import path\n+from django.http import HttpResponse\n+from django.conf.urls.i18n import i18n_patterns\n+from django.middleware.locale import LocaleMiddleware\n+from django.urls import resolve\n+from django.utils.translation import get_language_from_path, get_supported_language_variant\n+from django.urls.resolvers import LocalePrefixPattern\n+\n+# Configure Django settings\n+if not settings.configured:\n+    settings.configure(\n+        DEBUG=True,\n+        SECRET_KEY='test-secret-key',\n+        USE_I18N=True,\n+        LANGUAGE_CODE='en-us',\n+        LANGUAGES=[\n+            ('en-us', \"English\"),\n+            ('en-latn-us', \"Latin English\"),\n+            ('en-Latn-US', \"BCP 47 case format\"),\n+        ],\n+        MIDDLEWARE=[\n+            'django.middleware.locale.LocaleMiddleware',\n+        ],\n+        ROOT_URLCONF='debug_issue',\n+    )\n+\n+django.setup()\n+\n+def test_view(request):\n+    return HttpResponse('U!')\n+\n+# Define URL patterns\n+urlpatterns = i18n_patterns(\n+    path('', test_view, name='test'),\n+)\n+\n+def debug_language_processing():\n+    \"\"\"Debug the language processing step by step.\"\"\"\n+    print(\"Debugging language processing:\")\n+    print(\"=\" * 50)\n+    \n+    test_paths = [\n+        '/en-us/',\n+        '/en-latn-us/',\n+        '/en-Latn-US/',\n+    ]\n+    \n+    for path in test_paths:\n+        print(f\"\\nProcessing path: {path}\")\n+        \n+        # Step 1: Check get_language_from_path\n+        lang_from_path = get_language_from_path(path)\n+        print(f\"  get_language_from_path: {lang_from_path}\")\n+        \n+        # Step 2: Check get_supported_language_variant if we got a language\n+        if lang_from_path:\n+            try:\n+                supported_variant = get_supported_language_variant(lang_from_path)\n+                print(f\"  get_supported_language_variant: {supported_variant}\")\n+            except LookupError as e:\n+                print(f\"  get_supported_language_variant: LookupError - {e}\")\n+        \n+        # Step 3: Test LocalePrefixPattern.match directly\n+        pattern = LocalePrefixPattern()\n+        match_result = pattern.match(path)\n+        print(f\"  LocalePrefixPattern.match: {match_result}\")\n+        \n+        # Step 4: Test URL resolution\n+        try:\n+            match = resolve(path)\n+            print(f\"  URL resolution: SUCCESS - {match}\")\n+        except Exception as e:\n+            print(f\"  URL resolution: ERROR - {e}\")\n+\n+if __name__ == '__main__':\n+    debug_language_processing()\n\\ No newline at end of file\ndiff --git a/debug_middleware.py b/debug_middleware.py\nnew file mode 100644\nindex 0000000000..056f616bef\n--- /dev/null\n+++ b/debug_middleware.py\n@@ -0,0 +1,74 @@\n+#!/usr/bin/env python\n+\"\"\"\n+Debug the middleware processing.\n+\"\"\"\n+\n+import django\n+from django.conf import settings\n+from django.test import RequestFactory\n+from django.middleware.locale import LocaleMiddleware\n+from django.utils.translation import get_language, get_language_from_path\n+\n+# Configure Django settings\n+if not settings.configured:\n+    settings.configure(\n+        DEBUG=True,\n+        SECRET_KEY='test-secret-key',\n+        USE_I18N=True,\n+        LANGUAGE_CODE='en-us',\n+        LANGUAGES=[\n+            ('en-us', \"English\"),\n+            ('en-latn-us', \"Latin English\"),\n+            ('en-Latn-US', \"BCP 47 case format\"),\n+        ],\n+        MIDDLEWARE=[\n+            'django.middleware.locale.LocaleMiddleware',\n+        ],\n+        ALLOWED_HOSTS=['testserver'],\n+    )\n+\n+django.setup()\n+\n+from django.conf.urls.i18n import i18n_patterns\n+from django.http import HttpResponse\n+from django.urls import path\n+\n+def test_view(request):\n+    return HttpResponse('OK')\n+\n+# Create a test URLs module\n+import sys\n+from types import ModuleType\n+urls_module = ModuleType('test_urls')\n+urls_module.urlpatterns = i18n_patterns(path('', test_view))\n+sys.modules['test_urls'] = urls_module\n+settings.ROOT_URLCONF = 'test_urls'\n+\n+def debug_middleware():\n+    \"\"\"Debug the middleware processing.\"\"\"\n+    print(\"Debugging middleware processing:\")\n+    print(\"=\" * 50)\n+    \n+    factory = RequestFactory()\n+    middleware = LocaleMiddleware(lambda request: HttpResponse('OK'))\n+    \n+    test_paths = ['/en-us/', '/en-latn-us/', '/en-Latn-US/']\n+    \n+    for path in test_paths:\n+        print(f\"\\nProcessing path: {path}\")\n+        \n+        request = factory.get(path)\n+        print(f\"  Request path_info: {request.path_info}\")\n+        \n+        # Check get_language_from_path\n+        lang_from_path = get_language_from_path(request.path_info)\n+        print(f\"  get_language_from_path: {lang_from_path}\")\n+        \n+        # Process the request through middleware\n+        print(f\"  Language before middleware: {get_language()}\")\n+        middleware.process_request(request)\n+        print(f\"  Language after middleware: {get_language()}\")\n+        print(f\"  request.LANGUAGE_CODE: {getattr(request, 'LANGUAGE_CODE', 'Not set')}\")\n+\n+if __name__ == '__main__':\n+    debug_middleware()\n\\ No newline at end of file\ndiff --git a/debug_pattern.py b/debug_pattern.py\nnew file mode 100644\nindex 0000000000..b6ef9be81a\n--- /dev/null\n+++ b/debug_pattern.py\n@@ -0,0 +1,64 @@\n+#!/usr/bin/env python\n+\"\"\"\n+Debug the LocalePrefixPattern.match method specifically.\n+\"\"\"\n+\n+import os\n+import sys\n+import django\n+from django.conf import settings\n+from django.utils.translation import get_language, get_language_from_path, activate\n+from django.urls.resolvers import LocalePrefixPattern\n+\n+# Configure Django settings\n+if not settings.configured:\n+    settings.configure(\n+        DEBUG=True,\n+        SECRET_KEY='test-secret-key',\n+        USE_I18N=True,\n+        LANGUAGE_CODE='en-us',\n+        LANGUAGES=[\n+            ('en-us', \"English\"),\n+            ('en-latn-us', \"Latin English\"),\n+            ('en-Latn-US', \"BCP 47 case format\"),\n+        ],\n+    )\n+\n+django.setup()\n+\n+def debug_pattern_match():\n+    \"\"\"Debug the LocalePrefixPattern.match method.\"\"\"\n+    print(\"Debugging LocalePrefixPattern.match:\")\n+    print(\"=\" * 50)\n+    \n+    # Test with different active languages\n+    test_languages = ['en-us', 'en-latn-us', 'en-Latn-US']\n+    test_paths = ['/en-us/', '/en-latn-us/', '/en-Latn-US/']\n+    \n+    for active_lang in test_languages:\n+        print(f\"\\nActive language: {active_lang}\")\n+        activate(active_lang)\n+        \n+        pattern = LocalePrefixPattern()\n+        print(f\"  Current language: {get_language()}\")\n+        print(f\"  Language prefix: '{pattern.language_prefix}'\")\n+        \n+        for path in test_paths:\n+            print(f\"  Testing path: {path}\")\n+            \n+            # Check get_language_from_path\n+            lang_from_path = get_language_from_path(path)\n+            print(f\"    get_language_from_path: {lang_from_path}\")\n+            \n+            # Check pattern match\n+            match_result = pattern.match(path)\n+            print(f\"    pattern.match: {match_result}\")\n+            \n+            # Manual check of the logic\n+            if lang_from_path is not None:\n+                language_prefix = '%s/' % lang_from_path\n+                print(f\"    Constructed prefix: '{language_prefix}'\")\n+                print(f\"    path.startswith(prefix): {path.startswith(language_prefix)}\")\n+\n+if __name__ == '__main__':\n+    debug_pattern_match()\n\\ No newline at end of file\ndiff --git a/debug_pattern_detailed.py b/debug_pattern_detailed.py\nnew file mode 100644\nindex 0000000000..1628fb3852\n--- /dev/null\n+++ b/debug_pattern_detailed.py\n@@ -0,0 +1,66 @@\n+#!/usr/bin/env python\n+\"\"\"\n+Debug the LocalePrefixPattern in detail.\n+\"\"\"\n+\n+import os\n+import sys\n+import django\n+from django.conf import settings\n+from django.utils.translation import activate, get_language_from_path\n+from django.urls.resolvers import LocalePrefixPattern\n+\n+# Configure Django settings\n+if not settings.configured:\n+    settings.configure(\n+        DEBUG=True,\n+        SECRET_KEY='test-secret-key',\n+        USE_I18N=True,\n+        LANGUAGE_CODE='en-us',\n+        LANGUAGES=[\n+            ('en-us', \"English\"),\n+            ('en-latn-us', \"Latin English\"),\n+            ('en-Latn-US', \"BCP 47 case format\"),\n+        ],\n+        ALLOWED_HOSTS=['testserver'],\n+    )\n+\n+django.setup()\n+\n+def debug_pattern_detailed():\n+    \"\"\"Debug the LocalePrefixPattern in detail.\"\"\"\n+    print(\"Debugging LocalePrefixPattern in detail:\")\n+    print(\"=\" * 60)\n+    \n+    test_paths = ['/en-us/', '/en-latn-us/', '/en-Latn-US/']\n+    \n+    # Test with different active languages\n+    for active_lang in ['en-us', 'en-latn-us', 'en-Latn-US']:\n+        print(f\"\\nActive language: {active_lang}\")\n+        activate(active_lang)\n+        \n+        pattern = LocalePrefixPattern()\n+        print(f\"  Current language: {pattern.language_prefix}\")\n+        \n+        for path in test_paths:\n+            print(f\"  Testing path: {path}\")\n+            \n+            # Step 1: get_language_from_path\n+            lang_from_path = get_language_from_path(path)\n+            print(f\"    get_language_from_path: {lang_from_path}\")\n+            \n+            # Step 2: pattern.match\n+            match_result = pattern.match(path)\n+            print(f\"    pattern.match: {match_result}\")\n+            \n+            # Step 3: Manual simulation of the match logic\n+            if lang_from_path is not None:\n+                constructed_prefix = '/%s/' % lang_from_path\n+                print(f\"    Constructed prefix: '{constructed_prefix}'\")\n+                print(f\"    path.startswith(prefix): {path.startswith(constructed_prefix)}\")\n+                if path.startswith(constructed_prefix):\n+                    remaining = path[len(constructed_prefix):]\n+                    print(f\"    Remaining path: '{remaining}'\")\n+\n+if __name__ == '__main__':\n+    debug_pattern_detailed()\n\\ No newline at end of file\ndiff --git a/django/urls/resolvers.py b/django/urls/resolvers.py\nindex 6ea18dd22f..9e66915ac7 100644\n--- a/django/urls/resolvers.py\n+++ b/django/urls/resolvers.py\n@@ -23,7 +23,7 @@ from django.utils.datastructures import MultiValueDict\n from django.utils.functional import cached_property\n from django.utils.http import RFC3986_SUBDELIMS, escape_leading_slashes\n from django.utils.regex_helper import _lazy_re_compile, normalize\n-from django.utils.translation import get_language\n+from django.utils.translation import get_language, get_language_from_path\n \n from .converters import get_converter\n from .exceptions import NoReverseMatch, Resolver404\n@@ -321,6 +321,15 @@ class LocalePrefixPattern:\n             return '%s/' % language_code\n \n     def match(self, path):\n+        # First check if there's a valid language code in the path\n+        language_code = get_language_from_path(path)\n+        if language_code is not None:\n+            # If we found a valid language code, construct the prefix and match\n+            language_prefix = '/%s/' % language_code\n+            if path.startswith(language_prefix):\n+                return path[len(language_prefix):], (), {}\n+        \n+        # Fallback to the original behavior for the current language\n         language_prefix = self.language_prefix\n         if path.startswith(language_prefix):\n             return path[len(language_prefix):], (), {}\ndiff --git a/django/utils/translation/trans_real.py b/django/utils/translation/trans_real.py\nindex 7dcc77b46c..274a6f0643 100644\n--- a/django/utils/translation/trans_real.py\n+++ b/django/utils/translation/trans_real.py\n@@ -43,7 +43,7 @@ language_code_re = _lazy_re_compile(\n     re.IGNORECASE\n )\n \n-language_code_prefix_re = _lazy_re_compile(r'^/(\\w+([@-]\\w+)?)(/|$)')\n+language_code_prefix_re = _lazy_re_compile(r'^/(\\w+(?:[@-]\\w+)*)(/|$)')\n \n \n @receiver(setting_changed)\ndiff --git a/reproduce_issue.py b/reproduce_issue.py\nnew file mode 100644\nindex 0000000000..13e2372319\n--- /dev/null\n+++ b/reproduce_issue.py\n@@ -0,0 +1,106 @@\n+#!/usr/bin/env python\n+\"\"\"\n+Script to reproduce the i18n patterns issue with language locales containing both script and region.\n+\"\"\"\n+\n+import os\n+import sys\n+import django\n+from django.conf import settings\n+from django.test import RequestFactory\n+from django.urls import path\n+from django.http import HttpResponse\n+from django.conf.urls.i18n import i18n_patterns\n+from django.middleware.locale import LocaleMiddleware\n+from django.urls import resolve\n+from django.utils.translation import get_language_from_path\n+\n+# Configure Django settings\n+if not settings.configured:\n+    settings.configure(\n+        DEBUG=True,\n+        SECRET_KEY='test-secret-key',\n+        USE_I18N=True,\n+        LANGUAGE_CODE='en-us',\n+        LANGUAGES=[\n+            ('en-us', \"English\"),\n+            ('en-latn-us', \"Latin English\"),\n+            ('en-Latn-US', \"BCP 47 case format\"),\n+        ],\n+        MIDDLEWARE=[\n+            'django.middleware.locale.LocaleMiddleware',\n+        ],\n+        ROOT_URLCONF='reproduce_issue',\n+    )\n+\n+django.setup()\n+\n+def test_view(request):\n+    return HttpResponse('U!')\n+\n+# Define URL patterns\n+urlpatterns = i18n_patterns(\n+    path('', test_view, name='test'),\n+)\n+\n+def test_language_from_path():\n+    \"\"\"Test get_language_from_path function with different language codes.\"\"\"\n+    print(\"Testing get_language_from_path function:\")\n+    \n+    test_paths = [\n+        '/en-us/',\n+        '/en-latn-us/',\n+        '/en-Latn-US/',\n+    ]\n+    \n+    for path in test_paths:\n+        result = get_language_from_path(path)\n+        print(f\"  {path} -> {result}\")\n+    print()\n+\n+def test_url_resolution():\n+    \"\"\"Test URL resolution with different language prefixes.\"\"\"\n+    print(\"Testing URL resolution:\")\n+    \n+    test_paths = [\n+        '/en-us/',\n+        '/en-latn-us/',\n+        '/en-Latn-US/',\n+    ]\n+    \n+    for path in test_paths:\n+        try:\n+            match = resolve(path)\n+            print(f\"  {path} -> SUCCESS: {match}\")\n+        except Exception as e:\n+            print(f\"  {path} -> ERROR: {e}\")\n+    print()\n+\n+def test_middleware():\n+    \"\"\"Test LocaleMiddleware processing.\"\"\"\n+    print(\"Testing LocaleMiddleware:\")\n+    \n+    factory = RequestFactory()\n+    middleware = LocaleMiddleware(lambda request: HttpResponse('OK'))\n+    \n+    test_paths = [\n+        '/en-us/',\n+        '/en-latn-us/',\n+        '/en-Latn-US/',\n+    ]\n+    \n+    for path in test_paths:\n+        request = factory.get(path)\n+        try:\n+            middleware.process_request(request)\n+            print(f\"  {path} -> Language: {getattr(request, 'LANGUAGE_CODE', 'None')}\")\n+        except Exception as e:\n+            print(f\"  {path} -> ERROR: {e}\")\n+    print()\n+\n+if __name__ == '__main__':\n+    print(\"Reproducing i18n patterns issue with language locales containing both script and region\\n\")\n+    \n+    test_language_from_path()\n+    test_url_resolution()\n+    test_middleware()\n\\ No newline at end of file\ndiff --git a/test_original.py b/test_original.py\nnew file mode 100644\nindex 0000000000..3afe643d6d\n--- /dev/null\n+++ b/test_original.py\n@@ -0,0 +1,57 @@\n+#!/usr/bin/env python\n+\"\"\"\n+Test the original Django behavior with simple language codes.\n+\"\"\"\n+\n+import os\n+import sys\n+import django\n+from django.conf import settings\n+from django.utils.translation import activate\n+from django.urls.resolvers import LocalePrefixPattern\n+\n+# Configure Django settings\n+if not settings.configured:\n+    settings.configure(\n+        DEBUG=True,\n+        SECRET_KEY='test-secret-key',\n+        USE_I18N=True,\n+        LANGUAGE_CODE='en',\n+        LANGUAGES=[\n+            ('en', \"English\"),\n+            ('fr', \"French\"),\n+        ],\n+    )\n+\n+django.setup()\n+\n+def test_original_behavior():\n+    \"\"\"Test the original behavior with simple language codes.\"\"\"\n+    print(\"Testing original behavior:\")\n+    print(\"=\" * 50)\n+    \n+    # Test with English active\n+    activate('en')\n+    pattern = LocalePrefixPattern()\n+    print(f\"Active language: en\")\n+    print(f\"Language prefix: '{pattern.language_prefix}'\")\n+    \n+    test_paths = ['/en/', '/fr/', '/']\n+    for path in test_paths:\n+        match_result = pattern.match(path)\n+        print(f\"  {path} -> {match_result}\")\n+    \n+    print()\n+    \n+    # Test with French active\n+    activate('fr')\n+    pattern = LocalePrefixPattern()\n+    print(f\"Active language: fr\")\n+    print(f\"Language prefix: '{pattern.language_prefix}'\")\n+    \n+    for path in test_paths:\n+        match_result = pattern.match(path)\n+        print(f\"  {path} -> {match_result}\")\n+\n+if __name__ == '__main__':\n+    test_original_behavior()\n\\ No newline at end of file\ndiff --git a/test_regex.py b/test_regex.py\nnew file mode 100644\nindex 0000000000..278627bf4e\n--- /dev/null\n+++ b/test_regex.py\n@@ -0,0 +1,42 @@\n+#!/usr/bin/env python\n+\"\"\"\n+Test the current language_code_prefix_re regex to understand what it captures.\n+\"\"\"\n+\n+import re\n+\n+# Current regex from Django\n+language_code_prefix_re = re.compile(r'^/(\\w+([@-]\\w+)?)(/|$)')\n+\n+test_paths = [\n+    '/en/',\n+    '/en-us/',\n+    '/en-latn-us/',\n+    '/en-Latn-US/',\n+    '/zh-hant-tw/',\n+    '/fr-ca/',\n+]\n+\n+print(\"Testing current regex: r'^/(\\\\w+([@-]\\\\w+)?)(/|$)'\")\n+print(\"=\" * 50)\n+\n+for path in test_paths:\n+    match = language_code_prefix_re.match(path)\n+    if match:\n+        print(f\"{path:15} -> MATCH: groups={match.groups()}, group(1)='{match.group(1)}'\")\n+    else:\n+        print(f\"{path:15} -> NO MATCH\")\n+\n+print(\"\\n\" + \"=\" * 50)\n+print(\"Testing improved regex: r'^/(\\\\w+(?:[@-]\\\\w+)*)(/|$)'\")\n+print(\"=\" * 50)\n+\n+# Improved regex that can handle multiple parts\n+improved_regex = re.compile(r'^/(\\w+(?:[@-]\\w+)*)(/|$)')\n+\n+for path in test_paths:\n+    match = improved_regex.match(path)\n+    if match:\n+        print(f\"{path:15} -> MATCH: groups={match.groups()}, group(1)='{match.group(1)}'\")\n+    else:\n+        print(f\"{path:15} -> NO MATCH\")\n\\ No newline at end of file\ndiff --git a/test_three_part_lang.py b/test_three_part_lang.py\nnew file mode 100644\nindex 0000000000..7d2b9d581e\n--- /dev/null\n+++ b/test_three_part_lang.py\n@@ -0,0 +1,82 @@\n+#!/usr/bin/env python\n+\"\"\"\n+Test three-part language codes with i18n_patterns.\n+\"\"\"\n+\n+import os\n+import sys\n+import django\n+from django.conf import settings\n+from django.test import TestCase, override_settings\n+from django.test.client import Client\n+\n+# Add the testbed to the path\n+sys.path.insert(0, '/testbed')\n+\n+# Configure Django settings\n+if not settings.configured:\n+    settings.configure(\n+        DEBUG=True,\n+        SECRET_KEY='test-secret-key',\n+        USE_I18N=True,\n+        LANGUAGE_CODE='en-us',\n+        LANGUAGES=[\n+            ('en-us', \"English\"),\n+            ('en-latn-us', \"Latin English\"),\n+            ('en-Latn-US', \"BCP 47 case format\"),\n+        ],\n+        MIDDLEWARE=[\n+            'django.middleware.locale.LocaleMiddleware',\n+            'django.middleware.common.CommonMiddleware',\n+        ],\n+        ROOT_URLCONF='test_three_part_lang',\n+        ALLOWED_HOSTS=['testserver'],\n+        TEMPLATES=[{\n+            'BACKEND': 'django.template.backends.django.DjangoTemplates',\n+            'DIRS': [],\n+            'OPTIONS': {\n+                'context_processors': [\n+                    'django.template.context_processors.i18n',\n+                ],\n+            },\n+        }],\n+    )\n+\n+django.setup()\n+\n+from django.conf.urls.i18n import i18n_patterns\n+from django.http import HttpResponse\n+from django.urls import path\n+\n+def test_view(request):\n+    return HttpResponse('OK')\n+\n+# Define URL patterns\n+urlpatterns = i18n_patterns(\n+    path('', test_view, name='test'),\n+)\n+\n+class ThreePartLanguageCodeTests(TestCase):\n+    \"\"\"Test three-part language codes with i18n_patterns.\"\"\"\n+    \n+    def test_en_us_url(self):\n+        \"\"\"Test that en-us works.\"\"\"\n+        response = self.client.get('/en-us/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response.content, b'OK')\n+    \n+    def test_en_latn_us_url(self):\n+        \"\"\"Test that en-latn-us works.\"\"\"\n+        response = self.client.get('/en-latn-us/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response.content, b'OK')\n+    \n+    def test_en_Latn_US_url(self):\n+        \"\"\"Test that en-Latn-US works.\"\"\"\n+        response = self.client.get('/en-Latn-US/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response.content, b'OK')\n+\n+if __name__ == '__main__':\n+    import unittest\n+    unittest.main()\n\\ No newline at end of file\ndiff --git a/test_with_client.py b/test_with_client.py\nnew file mode 100644\nindex 0000000000..8b454d78d9\n--- /dev/null\n+++ b/test_with_client.py\n@@ -0,0 +1,68 @@\n+#!/usr/bin/env python\n+\"\"\"\n+Test the i18n patterns issue using Django test client.\n+\"\"\"\n+\n+import os\n+import sys\n+import django\n+from django.conf import settings\n+from django.test.client import Client\n+from django.conf.urls.i18n import i18n_patterns\n+from django.http import HttpResponse\n+from django.urls import path\n+\n+# Configure Django settings\n+if not settings.configured:\n+    settings.configure(\n+        DEBUG=True,\n+        SECRET_KEY='test-secret-key',\n+        USE_I18N=True,\n+        LANGUAGE_CODE='en-us',\n+        LANGUAGES=[\n+            ('en-us', \"English\"),\n+            ('en-latn-us', \"Latin English\"),\n+            ('en-Latn-US', \"BCP 47 case format\"),\n+        ],\n+        MIDDLEWARE=[\n+            'django.middleware.locale.LocaleMiddleware',\n+        ],\n+        ALLOWED_HOSTS=['testserver'],\n+    )\n+\n+django.setup()\n+\n+def test_view(request):\n+    return HttpResponse('U!')\n+\n+# Create a test URLs module\n+import sys\n+from types import ModuleType\n+urls_module = ModuleType('test_urls')\n+urls_module.urlpatterns = i18n_patterns(\n+    path('', test_view, name='test'),\n+)\n+sys.modules['test_urls'] = urls_module\n+\n+# Update settings to use our test URLs\n+settings.ROOT_URLCONF = 'test_urls'\n+\n+def test_with_client():\n+    \"\"\"Test using Django test client.\"\"\"\n+    print(\"Testing with Django test client:\")\n+    print(\"=\" * 50)\n+    \n+    client = Client()\n+    \n+    test_paths = [\n+        '/en-us/',\n+        '/en-latn-us/',\n+        '/en-Latn-US/',\n+    ]\n+    \n+    for path in test_paths:\n+        response = client.get(path)\n+        print(f\"  GET {path} -> {response.status_code} {response.content.decode()}\")\n+\n+if __name__ == '__main__':\n+    test_with_client()\n\\ No newline at end of file\n"}